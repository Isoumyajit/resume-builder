# =============================================================================
# GitHub Actions - Pull Request Checks
# =============================================================================
# Single orchestrator for all PR validation on pull requests targeting main.
#
# Pipeline:
#   1. Prerequisites (branch name + CodeQL)  — runs once
#   2. Code quality + Unit tests             — run after prerequisites pass
#   3. Docker build                          — runs after both test suites pass
#   4. Security audit                        — runs alongside tests (advisory)
#
# Skipped entirely for changes to: docs/, *.md, LICENSE, .gitignore
#
# Requirements:
#   1. Branch name must follow: type/RB-description (e.g. feature/RB-add-export)
#   2. CodeQL security analysis must pass
#   3. All tests must pass (Frontend + Backend)
#   4. Docker images must build successfully
#   5. PR must be approved by @Isoumyajit (configured in Branch Protection)
# =============================================================================

name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "LICENSE"
      - ".gitignore"

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Stage 1: Prerequisites — Branch Name + CodeQL (single run)
  # ===========================================================================
  prerequisite:
    name: Prerequisites
    uses: ./.github/workflows/_prerequisites-pr.yml
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read
    secrets: inherit

  # ===========================================================================
  # Stage 2a: Frontend Code Quality (after prerequisites)
  # ===========================================================================
  frontend:
    name: Frontend Quality
    runs-on: ubuntu-latest
    needs: prerequisite
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type Check
        run: npx tsc --build

      - name: Build
        run: npm run build
        env:
          VITE_API_URL: http://localhost:3001
          VITE_API_VERSION: v1

  # ===========================================================================
  # Stage 2b: Unit Tests (after prerequisites)
  # ===========================================================================
  tests:
    name: Unit Tests
    needs: prerequisite
    uses: ./.github/workflows/rb_unit-tests.yml
    secrets: inherit

  # ===========================================================================
  # Stage 2c: Security Audit (after prerequisites, advisory only)
  # ===========================================================================
  security:
    name: Security
    runs-on: ubuntu-latest
    needs: prerequisite
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Audit Frontend
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Audit Backend
        working-directory: server
        run: npm audit --audit-level=high
        continue-on-error: true

  # ===========================================================================
  # Stage 3: Docker Build (only after tests + frontend quality pass)
  # ===========================================================================
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [frontend, tests]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          build-args: |
            VITE_API_URL=http://localhost:3001
            VITE_API_VERSION=v1
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Backend
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # Final Status Check
  # ===========================================================================
  pr-status:
    name: PR Status
    runs-on: ubuntu-latest
    needs: [prerequisite, frontend, tests, docker, security]
    if: always()
    steps:
      - name: Check All Jobs
        run: |
          echo "## PR Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Prerequisites (Branch + CodeQL) | ${{ needs.prerequisite.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Quality | ${{ needs.frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.prerequisite.result }}" == "failure" ]]; then
            echo ""
            echo "❌ Prerequisites failed — check branch naming convention and CodeQL"
            exit 1
          fi

          if [[ "${{ needs.frontend.result }}" == "failure" ]]; then
            echo ""
            echo "❌ Frontend quality checks failed"
            exit 1
          fi

          if [[ "${{ needs.tests.result }}" == "failure" ]]; then
            echo ""
            echo "❌ Unit tests failed"
            exit 1
          fi

          if [[ "${{ needs.docker.result }}" == "failure" ]]; then
            echo ""
            echo "❌ Docker build failed"
            exit 1
          fi

          echo ""
          echo "✅ All checks passed!"
