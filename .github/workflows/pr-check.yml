# =============================================================================
# GitHub Actions - Pull Request Checks
# =============================================================================
# Runs all validation checks on pull requests targeting main.
# All checks must pass before merging is allowed.
#
# Requirements:
#   1. Branch name must follow: RB-[feature|fix|improvement]-[description]
#   2. All tests must pass (Frontend, Backend, Docker, Security)
#   3. PR must be approved by @Isoumyajit (configured in Branch Protection)
# Runs all validation checks on pull requests targeting main.
# All checks must pass before merging is allowed.
#
# Requirements:
#   1. Branch name must follow: RB-[feature|fix|improvement]-[description]
#   2. All tests must pass (Frontend, Backend, Docker, Security)
#   3. PR must be approved by @Isoumyajit (configured in Branch Protection)
# =============================================================================

name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

concurrency:
  group: pr-${{ github.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Prerequisites - Validate Branch Name
  # ===========================================================================
  prerequisite:
    name: Prerequisites
    uses: ./.github/workflows/_prerequisites-pr.yml
    secrets: inherit

  # ===========================================================================
  # Prerequisites - Validate Branch Name
  # ===========================================================================
  prerequisite:
    name: Prerequisites
    uses: ./.github/workflows/_prerequisites-pr.yml
    secrets: inherit

  # ===========================================================================
  # Frontend Checks
  # ===========================================================================
  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    needs: prerequisite
    needs: prerequisite
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type Check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build
        env:
          VITE_API_URL: http://localhost:3001
          VITE_API_VERSION: v1

  # ===========================================================================
  # Backend Checks
  # ===========================================================================
  backend:
    name: Backend
    runs-on: ubuntu-latest
    needs: prerequisite
    needs: prerequisite
    defaults:
      run:
        working-directory: server
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          node-version: "20"
          cache: "npm"
          cache-dependency-path: server/package-lock.json

      - name: Install
        run: npm ci

  # ===========================================================================
  # Docker Build Check
  # ===========================================================================
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: prerequisite
    needs: prerequisite
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          build-args: |
            VITE_API_URL=http://localhost:3001
            VITE_API_VERSION=v1
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Backend
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # Security Audit
  # ===========================================================================
  security:
    name: Security
    runs-on: ubuntu-latest
    needs: prerequisite
    needs: prerequisite
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          node-version: "20"

      - name: Audit Frontend
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Audit Backend
        working-directory: server
        run: npm audit --audit-level=high
        continue-on-error: true

  # ===========================================================================
  # Final Status Check
  # ===========================================================================
  pr-status:
    name: PR Status
    permissions:
      contents: read
    runs-on: ubuntu-latest
    needs: [prerequisite, frontend, backend, docker, security]
    if: always()
    steps:
      - name: Check All Jobs
        run: |
          echo "## PR Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Prerequisites | ${{ needs.prerequisite.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ needs.docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.prerequisite.result }}" == "failure" ]]; then
            echo ""
            echo "❌ Prerequisites failed - check branch naming convention"
            exit 1
          fi

          # Consolidated failure checks for Frontend, Backend, and Docker
          declare -A CHECK_RESULTS=(
            ["Frontend"]="${{ needs.frontend.result }}"
            ["Backend"]="${{ needs.backend.result }}"
            ["Docker"]="${{ needs.docker.result }}"
          )

          for CHECK_NAME in "${!CHECK_RESULTS[@]}"; do
            if [[ "${CHECK_RESULTS[$CHECK_NAME]}" == "failure" ]]; then
              echo ""
              if [[ "$CHECK_NAME" == "Docker" ]]; then
                echo "❌ Docker build failed"
              else
                echo "❌ $CHECK_NAME checks failed"
              fi
              exit 1
            fi
          done
          echo ""
          echo "✅ All checks passed!"
