# =============================================================================
# GitHub Actions - Main CI Pipeline
# =============================================================================
# Orchestrates the complete CI/CD pipeline for pushes to main:
#   1. Check if code changed (skip pipeline for docs-only commits)
#   2. CodeQL + Unit Tests (in parallel)
#   3. Deploy to GCP Cloud Run (only if both pass)
#
# Skipped entirely for changes to: docs/, *.md, LICENSE, .gitignore
# =============================================================================

name: CI Pipeline

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "LICENSE"
      - ".gitignore"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Step 1: CodeQL + Unit Tests (in parallel — no dependency between them)
  # ===========================================================================
  codeql:
    name: CodeQL
    uses: ./.github/workflows/_codeQL.yml
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

  unit-tests:
    name: Unit Tests
    uses: ./.github/workflows/rb_unit-tests.yml
    permissions:
      contents: read

  # ===========================================================================
  # Step 2: Deploy (runs only after BOTH CodeQL and tests pass)
  # ===========================================================================
  deploy:
    name: Deploy
    needs: [codeql, unit-tests]
    uses: ./.github/workflows/deploy.yml
    permissions:
      contents: read
      id-token: write
    with:
      environment: production
    secrets:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_REGION: ${{ secrets.GCP_REGION }}
      GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

  # ===========================================================================
  # Pipeline Summary
  # ===========================================================================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [codeql, unit-tests, deploy]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL | ${{ needs.codeql.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result == 'success' && '✅ Passed' || needs.unit-tests.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result == 'success' && '✅ Passed' || needs.deploy.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check Pipeline Status
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "✅ Pipeline completed successfully!"
          else
            echo "❌ Pipeline failed or was skipped"
            exit 1
          fi
