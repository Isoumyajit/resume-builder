# =============================================================================
# GitHub Actions - Build and Deploy to Cloud Run
# =============================================================================
# Builds Docker images and deploys to Google Cloud Run using Workload Identity
# Federation. Called by CI pipeline after all tests pass.
# =============================================================================

name: Build and Deploy to Cloud Run

on:
  workflow_call:
    inputs:
      environment:
        description: "Deployment environment"
        required: false
        default: "production"
        type: string
    secrets:
      GCP_PROJECT_ID:
        required: true
      GCP_REGION:
        required: true
      GCP_WORKLOAD_IDENTITY_PROVIDER:
        required: true

  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "production"
        type: choice
        options: [production, staging]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
  FRONTEND_SERVICE: resume-builder-frontend
  BACKEND_SERVICE: resume-builder-backend

jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}

      - name: Docker Auth
        uses: docker/login-action@v3
        with:
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.auth_token }}
          registry: ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Push Backend
        run: |
          BACKEND_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/resume-builder/${{ env.BACKEND_SERVICE }}:${{ github.sha }}"
          docker build --tag "${BACKEND_TAG}" -f server/Dockerfile ./server
          docker push "${BACKEND_TAG}"
          echo "BACKEND_IMAGE=${BACKEND_TAG}" >> $GITHUB_ENV

      - name: Build and Push Frontend
        run: |
          FRONTEND_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/resume-builder/${{ env.FRONTEND_SERVICE }}:${{ github.sha }}"
          docker build --tag "${FRONTEND_TAG}" \
            --build-arg VITE_API_URL=https://${{ env.BACKEND_SERVICE }}-${{ env.PROJECT_ID }}.${{ env.REGION }}.run.app \
            --build-arg VITE_API_VERSION=v1 \
            --build-arg VITE_NODE_ENV=production \
            -f Dockerfile .
          docker push "${FRONTEND_TAG}"
          echo "FRONTEND_IMAGE=${FRONTEND_TAG}" >> $GITHUB_ENV

      - name: Deploy Backend
        id: deploy-backend
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.BACKEND_SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ env.BACKEND_IMAGE }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy Frontend
        id: deploy-frontend
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.FRONTEND_SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ env.FRONTEND_IMAGE }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.deploy-backend.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.deploy-frontend.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
