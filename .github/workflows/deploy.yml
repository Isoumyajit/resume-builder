# =============================================================================
# GitHub Actions - Build and Deploy to Cloud Run
# =============================================================================
# Builds Docker images and deploys to Google Cloud Run using Workload Identity
# Federation. Called by CI pipeline after all tests pass.
#
# Includes post-deploy health checks to verify both services are responding.
# =============================================================================

name: Build and Deploy to Cloud Run

on:
  workflow_call:
    inputs:
      environment:
        description: "Deployment environment"
        required: false
        default: "production"
        type: string
    secrets:
      GCP_PROJECT_ID:
        required: true
      GCP_REGION:
        required: true
      GCP_WORKLOAD_IDENTITY_PROVIDER:
        required: true
      GEMINI_API_KEY:
        required: false

  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "production"
        type: choice
        options: [production, staging]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  FRONTEND_SERVICE: resume-builder-frontend
  BACKEND_SERVICE: resume-builder-backend

jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    outputs:
      backend_url: ${{ steps.deploy-backend.outputs.backend_url }}
      frontend_url: ${{ steps.deploy-frontend.outputs.frontend_url }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}

      - name: Docker Auth
        uses: docker/login-action@v3
        with:
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.auth_token }}
          registry: ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Push Backend
        run: |
          BACKEND_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/resume-builder/${{ env.BACKEND_SERVICE }}:${{ github.sha }}"
          docker build --tag "${BACKEND_IMAGE}" -f server/Dockerfile ./server
          docker push "${BACKEND_IMAGE}"
          echo "BACKEND_IMAGE=${BACKEND_IMAGE}" >> $GITHUB_ENV

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy Backend
        id: deploy-backend
        run: |
          gcloud run deploy ${{ env.BACKEND_SERVICE }} \
            --image=${{ env.BACKEND_IMAGE }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --set-env-vars="NODE_ENV=production,GEMINI_API_KEY=${{ env.GEMINI_API_KEY }}"

          # Get the service URL
          BACKEND_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(status.url)")
          echo "backend_url=${BACKEND_URL}" >> $GITHUB_OUTPUT
          echo "BACKEND_URL=${BACKEND_URL}" >> $GITHUB_ENV
          echo "Backend deployed to: ${BACKEND_URL}"

      - name: Build and Push Frontend
        run: |
          FRONTEND_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/resume-builder/${{ env.FRONTEND_SERVICE }}:${{ github.sha }}"
          docker build --tag "${FRONTEND_IMAGE}" \
            --build-arg VITE_API_URL=${{ env.BACKEND_URL }} \
            --build-arg VITE_API_VERSION=v1 \
            --build-arg VITE_NODE_ENV=production \
            -f Dockerfile .
          docker push "${FRONTEND_IMAGE}"
          echo "FRONTEND_IMAGE=${FRONTEND_IMAGE}" >> $GITHUB_ENV

      - name: Deploy Frontend
        id: deploy-frontend
        run: |
          gcloud run deploy ${{ env.FRONTEND_SERVICE }} \
            --image=${{ env.FRONTEND_IMAGE }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --platform=managed \
            --port=80 \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=3 \
            --format="value(status.url)"

          # Get the service URL
          FRONTEND_URL=$(gcloud run services describe ${{ env.FRONTEND_SERVICE }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(status.url)")
          echo "frontend_url=${FRONTEND_URL}" >> $GITHUB_OUTPUT
          echo "Frontend deployed to: ${FRONTEND_URL}"

  # ===========================================================================
  # Post-Deploy Health Checks
  # ===========================================================================
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Wait for services to stabilize
        run: sleep 15

      - name: Check Backend Health
        id: backend-health
        run: |
          BACKEND_URL="${{ needs.deploy.outputs.backend_url }}"
          echo "Checking backend at: ${BACKEND_URL}/health"

          HTTP_STATUS=$(curl -s -o /tmp/backend-response.json -w "%{http_code}" \
            --max-time 30 --retry 3 --retry-delay 5 \
            "${BACKEND_URL}/health")

          echo "Backend response: HTTP ${HTTP_STATUS}"
          cat /tmp/backend-response.json

          if [[ "$HTTP_STATUS" -ge 200 && "$HTTP_STATUS" -lt 300 ]]; then
            echo "✅ Backend is healthy (HTTP ${HTTP_STATUS})"
            echo "healthy=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Backend health check failed (HTTP ${HTTP_STATUS})"
            echo "healthy=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Check Frontend Health
        id: frontend-health
        run: |
          FRONTEND_URL="${{ needs.deploy.outputs.frontend_url }}"
          echo "Checking frontend at: ${FRONTEND_URL}"

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 30 --retry 3 --retry-delay 5 \
            "${FRONTEND_URL}")

          echo "Frontend response: HTTP ${HTTP_STATUS}"

          if [[ "$HTTP_STATUS" -ge 200 && "$HTTP_STATUS" -lt 400 ]]; then
            echo "✅ Frontend is healthy (HTTP ${HTTP_STATUS})"
            echo "healthy=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Frontend health check failed (HTTP ${HTTP_STATUS})"
            echo "healthy=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL | Health |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy.outputs.backend_url }} | ${{ steps.backend-health.outputs.healthy == 'true' && '✅ Healthy' || '❌ Unhealthy' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy.outputs.frontend_url }} | ${{ steps.frontend-health.outputs.healthy == 'true' && '✅ Healthy' || '❌ Unhealthy' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
