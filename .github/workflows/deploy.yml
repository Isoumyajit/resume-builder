# =============================================================================
# GitHub Actions - Build and Deploy to Cloud Run
# =============================================================================
# Builds Docker images and deploys to Google Cloud Run using Workload Identity
# Federation. Called by CI pipeline after all tests pass.
# =============================================================================

name: Build and Deploy to Cloud Run

on:
  workflow_call:
    inputs:
      environment:
        description: "Deployment environment"
        required: false
        default: "production"
        type: string
    secrets:
      GCP_PROJECT_ID:
        required: true
      GCP_REGION:
        required: true
      GCP_WORKLOAD_IDENTITY_PROVIDER:
        required: true

  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "production"
        type: choice
        options: [production, staging]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
  FRONTEND_SERVICE: resume-builder-frontend
  BACKEND_SERVICE: resume-builder-backend

jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}

      - name: Docker Auth
        uses: docker/login-action@v3
        with:
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.auth_token }}
          registry: ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Push Backend
        run: |
          BACKEND_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/resume-builder/${{ env.BACKEND_SERVICE }}:${{ github.sha }}"
          docker build --tag "${BACKEND_IMAGE}" -f server/Dockerfile ./server
          docker push "${BACKEND_IMAGE}"
          echo "BACKEND_IMAGE=${BACKEND_IMAGE}" >> $GITHUB_ENV

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy Backend
        id: deploy-backend
        run: |
          gcloud run deploy ${{ env.BACKEND_SERVICE }} \
            --image=${{ env.BACKEND_IMAGE }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --platform=managed \
            --memory=2Gi \
            --cpu=2 \
            --cpu-boost \
            --timeout=300 \
            --min-instances=0 \
            --max-instances=3 \
            --set-env-vars="NODE_ENV=production" \
            --startup-cpu-boost \
            --no-cpu-throttling \
            --startup-probe-http-get-path=/api/v1/health \
            --startup-probe-initial-delay-seconds=0 \
            --startup-probe-timeout-seconds=240 \
            --startup-probe-period-seconds=10 \
            --startup-probe-failure-threshold=3 \
            --format="value(status.url)"
          
          # Get the service URL
          BACKEND_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(status.url)")
          echo "backend_url=${BACKEND_URL}" >> $GITHUB_OUTPUT
          echo "BACKEND_URL=${BACKEND_URL}" >> $GITHUB_ENV
          echo "Backend deployed to: ${BACKEND_URL}"

      - name: Build and Push Frontend
        run: |
          FRONTEND_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/resume-builder/${{ env.FRONTEND_SERVICE }}:${{ github.sha }}"
          docker build --tag "${FRONTEND_IMAGE}" \
            --build-arg VITE_API_URL=${{ env.BACKEND_URL }} \
            --build-arg VITE_API_VERSION=v1 \
            --build-arg VITE_NODE_ENV=production \
            -f Dockerfile .
          docker push "${FRONTEND_IMAGE}"
          echo "FRONTEND_IMAGE=${FRONTEND_IMAGE}" >> $GITHUB_ENV

      - name: Deploy Frontend
        id: deploy-frontend
        run: |
          gcloud run deploy ${{ env.FRONTEND_SERVICE }} \
            --image=${{ env.FRONTEND_IMAGE }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --platform=managed \
            --port=80 \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=3 \
            --format="value(status.url)"
          
          # Get the service URL
          FRONTEND_URL=$(gcloud run services describe ${{ env.FRONTEND_SERVICE }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(status.url)")
          echo "frontend_url=${FRONTEND_URL}" >> $GITHUB_OUTPUT
          echo "Frontend deployed to: ${FRONTEND_URL}"

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.deploy-backend.outputs.backend_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.deploy-frontend.outputs.frontend_url }} |" >> $GITHUB_STEP_SUMMARY
