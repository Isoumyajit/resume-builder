# =============================================================================
# GitHub Actions - Prerequisites (Reusable Workflow)
# =============================================================================
# Validates branch naming convention and runs CodeQL security analysis.
#
# Flow:
#   1. Validate branch name (RB-[type]-[description])
#   2. Run CodeQL security scan
#   3. Only if both pass → Unit tests can run
#
# Branch naming pattern: RB-[type]-[description]
#   - Type: feature, fix, improvement
#   - Description: lowercase letters, hyphens only (no numbers)
#
# Examples:
#   ✅ RB-feature-add-pdf-export
#   ✅ RB-fix-cors-issue
#   ✅ RB-improvement-refactor-api
#   ❌ RB-feature-add-v2-export (contains number)
#   ❌ feature-add-export (missing RB prefix)
# =============================================================================

name: Prerequisites

on:
  workflow_call:
    outputs:
      branch-valid:
        description: "Whether branch name follows convention"
        value: ${{ jobs.validate-branch.outputs.valid }}
      codeql-passed:
        description: "Whether CodeQL analysis passed"
        value: ${{ jobs.codeql.outputs.passed }}
      all-passed:
        description: "Whether all prerequisites passed"
        value: ${{ jobs.summary.outputs.passed }}

jobs:
  # ===========================================================================
  # Step 1: Validate Branch Name
  # ===========================================================================
  validate-branch:
    name: Validate Branch Name
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.check.outputs.valid }}
    steps:
      - name: Check Branch Naming Convention
        id: check
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Branch: $BRANCH_NAME"

          # Pattern: RB-[feature|fix|improvement]-[lowercase-letters-and-hyphens-only]
          PATTERN="^RB-(feature|fix|improvement)-[a-z]+(-[a-z]+)*$"

          if [[ "$BRANCH_NAME" =~ $PATTERN ]]; then
            echo "✅ Branch name follows convention: $BRANCH_NAME"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Invalid branch name: $BRANCH_NAME"
            echo ""
            echo "Branch name must follow pattern: RB-[type]-[description]"
            echo ""
            echo "Valid types: feature, fix, improvement"
            echo "Description: lowercase letters and hyphens only (NO numbers)"
            echo ""
            echo "Examples:"
            echo "  ✅ RB-feature-add-pdf-export"
            echo "  ✅ RB-fix-cors-issue"
            echo "  ✅ RB-improvement-refactor-api"
            echo ""
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  # ===========================================================================
  # Step 2: Run CodeQL Security Analysis (Only if branch name is valid)
  # ===========================================================================
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    needs: validate-branch
    outputs:
      passed: ${{ steps.result.outputs.passed }}
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - language: javascript-typescript
            build-mode: none
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          build-mode: ${{ matrix.build-mode }}

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

      - name: Set Result
        id: result
        if: success()
        run: |
          echo "✅ CodeQL analysis passed"
          echo "passed=true" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Step 3: Summary
  # ===========================================================================
  summary:
    name: Prerequisites Summary
    runs-on: ubuntu-latest
    needs: [validate-branch, codeql]
    if: always()
    outputs:
      passed: ${{ steps.check.outputs.passed }}
    steps:
      - name: Check All Prerequisites
        id: check
        run: |
          echo "## Prerequisites Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch Name | ${{ needs.validate-branch.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL | ${{ needs.codeql.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.validate-branch.result }}" == "success" && "${{ needs.codeql.result }}" == "success" ]]; then
            echo "✅ All prerequisites passed!" >> $GITHUB_STEP_SUMMARY
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Prerequisites failed" >> $GITHUB_STEP_SUMMARY
            echo "passed=false" >> $GITHUB_OUTPUT
            
            if [[ "${{ needs.validate-branch.result }}" != "success" ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Branch Naming Issue" >> $GITHUB_STEP_SUMMARY
              echo "Branch must follow: \`RB-[feature|fix|improvement]-[description]\`" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [[ "${{ needs.codeql.result }}" != "success" ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### CodeQL Issue" >> $GITHUB_STEP_SUMMARY
              echo "Security analysis found issues. Check the Security tab." >> $GITHUB_STEP_SUMMARY
            fi
            
            exit 1
          fi
